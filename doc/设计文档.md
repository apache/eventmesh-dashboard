# 前言

# 整体架构设计

## 主因子

![画板](https://cdn.nlark.com/yuque/0/2025/jpeg/1509048/1764878781688-b43b3acc-03c3-4907-ab72-ee856860ef69.jpeg)

## 架构略图

![画板](https://cdn.nlark.com/yuque/0/2025/jpeg/1509048/1764730146232-e06895bd-69a5-4e71-9141-af38f6227cdb.jpeg)

## 主流程图

> 主要流程流转图
>



![画板](https://cdn.nlark.com/yuque/0/2025/jpeg/1509048/1764675942640-32a72c77-b800-4527-a9d3-0ce3d6d0a31b.jpeg)

# Console 子系统（独立部署）

> console 子模块是管理系统，负责 构建整体运行态
>

+ 业务模块
+ 自动部署模块
+ 架构关系模块
+ agent 模块
+ function 模块
+ 指标展示模块
+ 生产与消费可视化模块
+ input 模块（目前没有设计）

## 业务模块

## 集群创建

+ 已有集群通过 地址 直接创建
+ 通过 自动部署模块创建

## 架构关系模块

> 架构关系是 整个项目双核模块之一。从 主因子 的视图关系，可以看到，不同的组件不同的架构，相同的组件也有不同的架构，组件同时以来多种其他组件，相同依赖类型同时支持多种组件。以及混乱
> 的 API 行为等等
>
> 比如:
>
> + Kafka 支持 zookepper 与 Kraft 为注册中心，并且独享注册中心
> + RocketMQ broker 支持 主从架构 和 ratf 架构
> + Pulast 支持 zookepper ， etcd 等注册中心，共享注册中心
    >
- Pulat 集群有 当前集群注册中心，还有一个 跨集群同步 注册中心
> + 复杂操作如：
    >
- 操作当前 集群空间下所有 broker
>     - 操作当前 集群空间下所有 zookeeper 注册中心
>     - 为当前 集群下 kafka，RockeMQ，Palsar 添加一个新 Topic
>     - 等等等等
>
> 架构关系是解决 在 **多种架构** 和 **多种多依赖** 的之间 巨大差异，通过统一行为，屏蔽底层细节，对模块进行深度解
>



![画板](https://cdn.nlark.com/yuque/0/2025/jpeg/1509048/1764833378606-938515b7-1295-499b-8266-1fe5b2fe3925.jpeg)

## 自动部署模块

### 部署模块图

### 部署架构与主流程图

![画板](https://cdn.nlark.com/yuque/0/2025/jpeg/1509048/1764819759990-25775a85-69ab-4030-8c65-34d7dc12fd3e.jpeg)

## 采集查询模块

> 采集查询模块（ReportController）在 console 的 查询模块相对比较简单，所有的逻辑都在 core 的 report 模块里面
>



重点：

+ 支持多个指标的查询
+ 支持单个子表的查询

## agent模块

> agent功能 主要是为了 支持 Agent 子系统。与 Agent 子系统完成 服务启动前的操作。  
> 确保当前节点启动之前 依赖启动成功
>

## 消费与生产模块

> 本模块只是为了方便 项目参与人员 测试与 mock 数据。查询指定数据，慢消费批量数据，如果 消息中间件支持链路跟踪，也可以查看相关信息
>

# core 子系统

> core 子系统是核心模块。有常量与枚举，metadata 等基础模块，以及下列核心功能
>



![画板](https://cdn.nlark.com/yuque/0/2025/jpeg/1509048/1764877150447-fbc3dbba-9a0a-42af-8600-f27797f91d7d.jpeg)

## SDK 模块

> SDK模块（ SDKManage ） 把 SDK 集中到一起，形成高内聚。
>



重点：

+ SDK 的类型有：admin，ping，生产者，消费者 四个类型 （SDKTypeEnum）
+ client 都对应个 Config 对象

## 远程服务模块

> 设计 console 目前需要调用 组件 对应的能力
>

## 心跳模块

重点：

+ 支持组件节点接的 ping 心跳
+ 支持 broker 级别的 topic 心跳，通知 check 延迟情况。 用于检查 单个broker 节点的生产与消费的健康
+ 心跳任务异步执行
+ 组件心跳异步回调，提高性能与吞吐率

## 同步数据模块

> 数据同步模块是 整个项目的双核之一。负责不同模式下 console metadata 同步到 组件 或则 组件 metadata 同步到 console。
>

### 架构关系图

同步模块主要四个主逻辑线

+ console sync db 创建流程 （ SyncMetadataCreateFactory ）
+ 同步行为创建 以及 db 和 组件 同步创建 流程 （MetadataSyncManage.register ）
+ sync 行为执行 流程 （ MetadataSyncWrapper.run ）
+ SyncManage 管理流程 （ MetadataSyncManage.run ）

### console sync db 创建流程

重点：

    - 是 metadata 维度， 负责 同步对应 metadata 对象，有多个metadata 就有多少 SyncMetadataCreateFactory
    - 负责从 db 读取 与 **批量**写入同步数据 同步数据，
    - 本逻辑第一次 全量读取 有效 metadata 数据，之后读取增量数据
    - 在 同步行为创建时，创建 BaseSyncBase（Cluster or Runtime）对应的 db MetadataHandler，其维度是 BaseSyncBase type +   BaseSyncBaseId +  metadata。 
        * 比如 负责 topic，注册一个 Id为 1的 kafka cluster 。维度是 Topic ， Cluster ， 1

### SyncManage 管理流程

重点：

    - 负责触发 console sync 读取 与写入 以及 同步行为
    - 有多个 metadata 以及 大量 组件，所以需要保证 操作的循序性
    - 提高吞吐量

![画板](https://cdn.nlark.com/yuque/0/2025/jpeg/1509048/1764876625558-96eb3f60-881d-4374-9f37-4f5d5e0c00fa.jpeg)

### sync 行为执行 流程

![画板](https://cdn.nlark.com/yuque/0/2025/jpeg/1509048/1764872488646-c857c419-039c-4111-9cff-fababa0352b4.jpeg)

### 模式如下

+ 创建时同步
    - 从 console 同步到 组件。 FirstToWhom.DASHBOARD
    - 从 组件 同步 console。FirstToWhom.RUNTIME
+ 运行时同步
    - 以 console 为主，从 console 同步到 组件 ClusterTrusteeshipType.SELF or TRUSTEESHIP
    - 以 组件的数据为主，即从 组件 同步 console。ClusterTrusteeshipType.TRUSTEESHIP_FIND_REVERSE
    - 不同步。ClusterTrusteeshipType.NOT or NO_TRUSTEESHIP
+ check（对比双非数据差异性）
    - 初始化时，check双方数据（MetadataSyncWrapper.initStatus）
    - 运行时，定时 check 双方数据（MetadataSyncWrapper.checkTime）

### 数据基本操作模块

> 数据基本操作模块负责 复杂场景下 数据的流通
>



![](https://cdn.nlark.com/yuque/0/2025/png/1509048/1764861703394-07351cf1-4e5d-40a2-aca7-ae2eaeb3545e.png)

### Difference 模块

> Difference 模块负责两个数据集在不同场景下的比较
>

![](https://cdn.nlark.com/yuque/0/2025/png/1509048/1764862179515-d629b2ee-62d8-4c01-b2cd-a7a4097b19bc.png)

# 指标子系统

> 目前还在 集成在 console 子系统里面。后期会独立出来，独立部署，有大量采集情况下，可能会影响 console 子系统的运行。在小规模采集任务情况，也可以集成到
> console里面，可以有一套简单架构
>

## 架构关系图

![画板](https://cdn.nlark.com/yuque/0/2025/jpeg/1509048/1764878542970-b17ea835-c3a3-4c93-ac3f-c8f44653a655.jpeg)

# agent子系统

# 新增组件流程

![画板](https://cdn.nlark.com/yuque/0/2025/jpeg/1509048/1764760018082-731af3df-565e-40f1-9c5d-7fd38d82ea4e.jpeg)

